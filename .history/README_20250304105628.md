# Azure infrastructure
---

## Getting started with Terraform

> Detailed documentation on working with Terraform is available on our GitHub profile.

Terraform is a very handy tool for quickly creating and managing a cloud infrastructure using configuration files. When configuration files are changed, Terraform automatically reacts to this and issues the appropriate commands to add or remove the resources the administrator needs. This article explains how to use Terraform (also abbreviated TF) to create a virtual infrastructure in the Azure Cloud.

## Step 1: Install Terraform

We will tell you how to install TF on Linux and Windows.

### Installing Terraform on Linux using Ubuntu as an example

First, use sudo to update the package list:

```bash
apt update
```

Then we install the packages we want and go to the folder where we want to install TF and download the right version of the package:

```bash
apt install wget unzip
```

```bash
cd ~
```

```bash
wget https://releases.hashicorp.com/terraform/x.x.x/terraform_x.x.x_linux_amd64.zip
```

In the last instruction, replace x.x.x.x with the current version number of the TF. You can view the current version here. Now unzip the archive and move it to the directory:

```bash
unzip terraform_x.x.x_linux_amd64.zip
```

```bash
mv terraform /usr/local/bin/
```

That's it, all that's left is to verify that TF is installed and available:

```bash
terraform -v
```

### Installing Terraform in Windows

The easiest thing to do here is to use the Chocolatey manager, which can be downloaded from here. To install Choco, open Powershell as administrator and run the following command:

```bash
Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
```

Once Chocolatey has been installed, open a command line (this can be done from the Start menu, but must be as an administrator) and type

```bash
choco install terraform
```

Check the installation using the same instructions:

```bash
terraform -v
```

## Step 1: Prepaire Azure account

### Set account
```bash
az account set -s f8368c46-055d-4b25-b4d4-7410f92cb8bc
```

That's it. To add that you can download the latest version of Terraform from the developer's website, and for more detailed instructions on how to install Terraform on Linux and Windows, see here. You may also need a command line utility to manage the Azure Cloud infrastructure via Terraform. For that, we have the Azure Cloud CLI, whose documentation can be found here. And we'll get down to setting it up.

## Step 2: Create a .tf configuration file

Configuration files in Terraform have a .tf extension. They can be given any name, but the software will still be able to retrieve information from them. Now let's create a new directory (let's call it azure_project), and then add a configuration file there, e.g. twcproject.tf. To get a file with this extension, you can first create a plain text file and then change its extension to .tf. Also note that only one configuration file can be contained in one directory, otherwise configuration errors may occur.

## Step 3: Configuring the provider

Setting up the ISP via a configuration file is done as follows. Add the following lines to the beginning of our twcproject.tf file:

```bash
terraform {
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "=3.0.1"
    }
  }
}
```

The source specifies the address of the provider (Azure Cloud in the example) and the version number of Terraform you can find out when downloading (we have specified the most recent version at the time of writing). Also note that only Terraform versions 0.13 and above are supported by the ISP.

Now enter the following command in the configuration file folder, which will install the ISP

```bash
terraform init
```

You can proceed to the next step. If you have a problem with your ISP installation, you can always contact our support team directly on chat.

## Step 4: Create and specify a token
In order to be able to work with the installed provider we will need the API-token, which can be obtained in the API & Terraform section of the Azure Cloud panel (you must be logged in to access this section).

Let's say we got the token fb246030216d5g30b1g6228e3071037g (this value here is only as an example, you will need to enter your token which will be generated for you). We add it via the provider:

```bash
provider "azurerm" {
  features {
    resource_group {
      prevent_deletion_if_contains_resources = false
    }
  }
  skip_provider_registration = "true"

  subscription_id = var.subscription_id
  client_id       = var.client_id
  client_secret   = var.client_secret
  tenant_id       = var.tenant_id
}

# Create a resource group
resource "azurerm_resource_group" "web" {
  name     = "azure-resource"
  location = "Poland Central"
}

# Create a virtual network within the resource group
resource "azurerm_virtual_network" "web" {
  name                = "web-network"
  resource_group_name = azurerm_resource_group.web.name
  location            = azurerm_resource_group.web.location
  address_space       = ["10.0.0.0/16"]
}

# Create a subnet
resource "azurerm_subnet" "azure-resource" {
  name                 = "web-subnet"
  resource_group_name  = azurerm_resource_group.web.name
  virtual_network_name = azurerm_virtual_network.web.name
  address_prefixes     = ["10.0.1.0/24"]
}

# Create a public IP address
resource "azurerm_public_ip" "azure-resource" {
  name                = "web-public-ip"
  location            = azurerm_resource_group.web.location
  resource_group_name = azurerm_resource_group.web.name
  allocation_method   = "Dynamic"
}

# Create a network interface
resource "azurerm_network_interface" "azure-resource" {
  name                = "web-network-interface"
  location            = azurerm_resource_group.web.location
  resource_group_name = azurerm_resource_group.web.name

  ip_configuration {
    name                          = "web-ip-configuration"
    subnet_id                     = azurerm_subnet.azure-resource.id
    private_ip_address_allocation = "Dynamic"
    public_ip_address_id          = azurerm_public_ip.azure-resource.id
  }
}
```

You can now start preparing the configuration. In case you need to be able to delete servers, you need to disable the confirmation of their deletion via Telegram. How to do this is described in a special article.

## Step 5: Prepare Configuration

Terraform enables you to manage various types of resources in your Azure Cloud. Let's take the example of creating a virtual machine (hereinafter referred to as VM) with a 100GB SSD, 2 cores, and 4GB RAM, use Ubuntu 20.04 as the operating system, and name our server something like my-azure-server (you can replace with your own name). To do this in the configuration file twcproject.tf we will write the following:

```bash
terraform {
  required_providers {
    azurerm = {
      source = "hashicorp/azurerm"
      version = "=3.0.1"
    }
  }
}

# Configure the AzureRM Provider
provider "azurerm" {
  features {
    resource_group {
      prevent_deletion_if_contains_resources = false
    }
  }
  skip_provider_registration = "true"

  subscription_id = var.subscription_id
  client_id       = var.client_id
  client_secret   = var.client_secret
  tenant_id       = var.tenant_id
}
```

You will also need a password to proceed, this will be emailed to you as soon as the resource is created.

Important: if the VM has not been created, check if you have TWC_TOKEN installed according to the instructions above. It's also worth paying attention to the error displayed by Terraform: you can often tell from it why the VM has not been created. Alternatively, you can set up access via SSH keys. If you don't know how to generate SSH keys, use these instructions. To load an SSH key, add the following block to the twcproject.tf configuration file

```bash
data "twc_ssh_keys" "your-key" {
  name = "Your key"
  body = file("~/.ssh/your-key.pub")
}
```

And in the resource block write the line ssh_keys_ids:

```bash
# Create a virtual machine
resource "azurerm_virtual_machine" "azure-resource" {
  name                  = "web-virtual-machine"
  location              = azurerm_resource_group.web.location
  resource_group_name   = azurerm_resource_group.web.name
  vm_size               = "Standard_DS3_v2" # 4 cores, 14 GB RAM
  network_interface_ids = [azurerm_network_interface.azure-resource.id]

  storage_image_reference {
    publisher = "Canonical"
    offer     = "0001-com-ubuntu-server-jammy"
    sku       = "22_04-lts-gen2"
    version   = "latest"
  }

  storage_os_disk {
    name              = "web-os-disk"
    caching           = "ReadWrite"
    create_option     = "FromImage"
    managed_disk_type = "Premium_LRS"
  }

  os_profile {
    computer_name  = var.instance_name
    admin_username = "organic"
  }

  os_profile_linux_config {
    disable_password_authentication = true

    ssh_keys {
      path     = "/home/organic/.ssh/authorized_keys"
      key_data = var.key_data  # Specify the path to your local public key file
    }
  }

  # Add a data disk
  storage_data_disk {
    name              = "web-data-disk"
    managed_disk_type = "Premium_LRS"
    create_option     = "Empty"
    disk_size_gb      = 100
    lun               = 0
  }
}
```

Note that only the public SSH key needs to be specified. This completes the preparations, a couple of simple steps remain.

## Step 6: Verify the configuration

To create secrets use
```bash
az ad sp create-for-rbac --role="Contributor" --scopes="/subscriptions/<SUBSCRIPTION_ID>"
```

To create secrets use with a name with the role Owner, Contributor, Reader
```bash
az ad sp create-for-rbac --name "vpn" --role="Owner" --scopes="/subscriptions/f8368c46-055d-4b25-b4d4-7410f92cb8bc"
```

This is done by the command:

```bash
terraform init
```

```bash
terraform validate
```

If the settings are correct, you will receive a message that the configuration is valid. If there is an error, check the settings again. All that's left now is to apply the configuration.

## Step 7: Apply the configuration
First, type in the following instructions:

```bash
terraform plan
```

It does not apply the changes, but only displays a list of resources to check the settings. If errors are detected, Terraform will not only display a standby message, but will also indicate where the errors have occurred. If everything is OK, however, enter:

```bash
terraform apply
```

This instruction applies the configurations you have created, so that your resources are ready and can already be worked with. But to apply the changes you will need to confirm them first, so on the line:

Enter a value:
enter yes and press Enter.

You can now check the resources you have created via the control panel. If, for any reason, you want to remove them, you can do so with the following instructions:

```bash
terraform destroy
```

You will also need to confirm the operation by typing yes and hitting Enter to confirm the deletion.

## Get new creds with a name 
az ad sp create-for-rbac --name "vpn_service_terraform_app" --role="Contributor" --scopes="/subscriptions/f8368c46-055d-4b25-b4d4-7410f92cb8bc"

## Conclusion

So far we've learned how to create Terraform configuration files, configure the ISP, and add resources and configure them so that we can work with them on the Azure Cloud server. But if you want to learn more about Terraform's instructions, you can read about them in the official documentation.